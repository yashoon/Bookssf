name: Android Release Build with Stages

on:
  push:
    branches:
      - 'feature/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§± Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ’¾ Upload Source Code for Next Jobs
        uses: actions/upload-artifact@v4
        with:
          name: source-code
          path: .
  
  install_deps:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: âš™ï¸ Set up Node and Install Dependencies
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - run: npm ci

      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: ğŸ“¦ Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: ğŸ’¾ Upload Node Modules and Gradle for Next Job
        uses: actions/upload-artifact@v4
        with:
          name: build-env
          path: |
            node_modules
            android/gradle
            android/gradlew
            android/gradlew.bat
            android/gradle.properties
            android/app/build.gradle
            android/build.gradle
            android/settings.gradle

  build_apk:
    needs: install_deps
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download Source Code
        uses: actions/download-artifact@v4
        with:
          name: source-code
          path: .

      - name: ğŸ“¥ Download Build Env
        uses: actions/download-artifact@v4
        with:
          name: build-env
          path: .

      - name: âš™ï¸ Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: ğŸ” Restore Keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/my-release-key.keystore

      - name: ğŸ”§ Configure Gradle Properties
        run: |
          echo "MYAPP_RELEASE_STORE_FILE=my-release-key.keystore" >> android/gradle.properties
          echo "MYAPP_RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> android/gradle.properties
          echo "MYAPP_RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}" >> android/gradle.properties
          echo "MYAPP_RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}" >> android/gradle.properties

      - name: âš™ï¸ Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¥ Install dependencies
        run: npm ci
        
      - name: ğŸ› ï¸ Make gradlew executable
        run: chmod +x android/gradlew
        
      - name: ğŸ—ï¸ Build Release APK
        run: cd android && ./gradlew assembleRelease

      - name: ğŸ’¾ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: android/app/build/outputs/apk/release/app-release.apk

  deploy:
    needs: build_apk
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-apk
          path: ./release

      - name: âœ… Notify or Publish (Optional)
        run: echo "Ready for deployment or Play Store upload"
  notify_discord:
    needs: build_apk
    runs-on: ubuntu-latest
    if: always()  # Ensures it runs even if previous jobs fail
    steps:
      - name: ğŸ“£ Notify Discord
        run: |
          STATUS="${{ needs.build_apk.result }}"
          if [ "$STATUS" = "success" ]; then
            COLOR="3066993"  # Green
            EMOJI="âœ…"
          elif [ "$STATUS" = "failure" ]; then
            COLOR="15158332"  # Red
            EMOJI="âŒ"
          else
            COLOR="8359053"  # Orange
            EMOJI="âš ï¸"
          fi

          curl -H "Content-Type: application/json" \
            -X POST -d "{
              \"username\": \"GitHub Actions Bot\",
              \"embeds\": [{
                \"title\": \"$EMOJI Build $STATUS\",
                \"description\": \"Repository: [${{ github.repository }}](https://github.com/${{ github.repository }})\\nBranch: \`${{ github.ref_name }}\`\\nCommit: [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                \"color\": $COLOR
              }]
            }" ${{ secrets.DISCORD_WEBHOOK_URL }}
