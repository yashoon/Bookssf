name: Android Release Build with Stages

on:
  push:
    branches:
      - 'feature/**'

jobs:
  build_apk:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§± Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ğŸ“¦ Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: ğŸ“¦ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/**/*.gradle*', 'android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: ğŸ“¥ Install Dependencies
        run: npm ci

      - name: âš™ï¸ Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: 17

      - name: ğŸ” Restore Keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 -d > android/app/my-release-key.keystore

      - name: ğŸ”§ Configure Gradle Properties
        run: |
          echo "MYAPP_RELEASE_STORE_FILE=my-release-key.keystore" >> android/gradle.properties
          echo "MYAPP_RELEASE_KEY_ALIAS=${{ secrets.RELEASE_KEY_ALIAS }}" >> android/gradle.properties
          echo "MYAPP_RELEASE_STORE_PASSWORD=${{ secrets.RELEASE_STORE_PASSWORD }}" >> android/gradle.properties
          echo "MYAPP_RELEASE_KEY_PASSWORD=${{ secrets.RELEASE_KEY_PASSWORD }}" >> android/gradle.properties

      - name: ğŸ› ï¸ Make gradlew Executable
        run: chmod +x android/gradlew

      - name: ğŸ—ï¸ Build Release APK
        run: cd android && ./gradlew assembleRelease --parallel --no-daemon --build-cache

      - name: ğŸ—ï¸ Build Bundle APK
        run: cd android && ./gradlew bundleRelease --parallel --no-daemon --build-cache

      - name: ğŸ’¾ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
      
      - name: ğŸ’¾ Upload AAB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab
      
      - name: ğŸš€ Upload to Google Play (Closed Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GPLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.bookssf
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: alpha   # ğŸ‘ˆ Uploads to Closed Testing track
          userFraction: 0.5  # ğŸ‘ˆ 50% rollout
          status: completed

  notify_discord:
    needs: build_apk
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“£ Notify Discord
        run: |
          STATUS="${{ needs.build_apk.result }}"
          if [ "$STATUS" = "success" ]; then
            COLOR="3066993"  # Green
            EMOJI="âœ…"
          elif [ "$STATUS" = "failure" ]; then
            COLOR="15158332"  # Red
            EMOJI="âŒ"
          else
            COLOR="8359053"  # Orange
            EMOJI="âš ï¸"
          fi
          curl -H "Content-Type: application/json" \
            -X POST -d "{
              \"username\": \"GitHub Actions Bot\",
              \"embeds\": [{
                \"title\": \"$EMOJI Build $STATUS\",
                \"description\": \"Repository: [${{ github.repository }}](https://github.com/${{ github.repository }})\\nBranch: \`${{ github.ref_name }}\`\\nCommit: [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\",
                \"color\": $COLOR
              }]
            }" ${{ secrets.DISCORD_WEBHOOK_URL }}
